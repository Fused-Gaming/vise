name: VISE CI/CD Pipeline

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: "18.x"
  FOUNDRY_PROFILE: ci

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 1: Security & Dependency Audit
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  security-audit:
    name: ðŸ”’ Security & Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸŽ¯ Setup Environment
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”’ Security & Dependency Audit"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ“ Repository: ${{ github.repository }}"
          echo "âœ“ Branch: ${{ github.ref_name }}"
          echo "âœ“ Commit: ${{ github.sha }}"
          echo "âœ“ Author: ${{ github.actor }}"
          echo ""

      - name: ðŸ” Check for exposed secrets
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Scanning for exposed secrets..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Check if .env is tracked
          if git ls-files --error-unmatch .env 2>/dev/null; then
            echo "âŒ CRITICAL: .env file is tracked in git!"
            exit 1
          else
            echo "âœ“ No .env file tracked in git"
          fi

          # Check for blockchain private keys
          echo ""
          echo "â†’ Checking for blockchain private keys..."
          if git grep -E "PRIVATE_KEY.*0x[a-fA-F0-9]{64}" HEAD 2>/dev/null; then
            echo "âŒ CRITICAL: Blockchain private key detected!"
            exit 1
          else
            echo "âœ“ No private keys detected"
          fi

          # Check for RPC URLs with API keys
          echo ""
          echo "â†’ Checking for RPC URLs with embedded API keys..."
          if git grep -E "(alchemy|infura)\.com/.*/[a-zA-Z0-9]{32,}" HEAD 2>/dev/null; then
            echo "âš ï¸  WARNING: RPC URL with API key detected!"
            echo "Please use environment variables instead"
          else
            echo "âœ“ No exposed RPC API keys"
          fi

      - name: ðŸ“¦ Setup Node.js
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ” npm Audit
        if: hashFiles('package.json') != ''
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Running npm security audit..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          npm install --package-lock-only
          npm audit --json > audit-results.json || true

          # Parse and display results
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-results.json)
          LOW=$(jq '.metadata.vulnerabilities.low // 0' audit-results.json)

          echo ""
          echo "Vulnerability Summary:"
          echo "  ðŸ”´ Critical: $CRITICAL"
          echo "  ðŸŸ  High:     $HIGH"
          echo "  ðŸŸ¡ Moderate: $MODERATE"
          echo "  ðŸŸ¢ Low:      $LOW"
          echo ""

          # Fail on critical or high vulnerabilities
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "âŒ Critical or high vulnerabilities found!"
            echo "Run 'npm audit fix' to resolve"
            exit 1
          else
            echo "âœ“ No critical security vulnerabilities"
          fi

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 2: Smart Contract Compilation & Testing
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  smart-contracts:
    name: ðŸ”— Smart Contracts
    runs-on: ubuntu-latest
    needs: security-audit
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ðŸŽ¯ Setup Environment
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”— Smart Contract Pipeline"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

      - name: ðŸ“¦ Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: ðŸ”¨ Compile contracts
        if: hashFiles('contracts/**/*.sol') != ''
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Compiling smart contracts..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ -d "contracts" ]; then
            cd contracts
            forge build --sizes
            echo "âœ“ Contracts compiled successfully"
          else
            echo "âš ï¸  No contracts directory found"
          fi

      - name: ðŸ§ª Run contract tests
        if: hashFiles('contracts/**/*.sol') != ''
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Running smart contract tests..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ -d "contracts" ]; then
            cd contracts
            forge test -vvv
            echo "âœ“ All contract tests passed"
          else
            echo "âš ï¸  No contracts directory found"
          fi

      - name: ðŸ“Š Generate coverage report
        if: hashFiles('contracts/**/*.sol') != ''
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Generating coverage report..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ -d "contracts" ]; then
            cd contracts
            forge coverage --report summary
            echo "âœ“ Coverage report generated"
          fi

      - name: ðŸ” Run Slither static analysis
        if: hashFiles('contracts/**/*.sol') != ''
        continue-on-error: true
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Running Slither static analysis..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          pip3 install slither-analyzer
          if [ -d "contracts" ]; then
            cd contracts
            slither . --print human-summary || echo "âš ï¸  Slither found potential issues (review recommended)"
          fi

      - name: ðŸ“Š Contract Report
        if: always()
        run: |
          cat > $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ”— Smart Contract Analysis

          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}

          ### Results

          - âœ… Contract compilation completed
          - âœ… Test suite executed
          - âœ… Coverage report generated
          - âœ… Static analysis performed

          ### Next Steps

          - Review Slither analysis results
          - Ensure test coverage >80%
          - Verify gas optimization
          - Prepare for testnet deployment

          ---
          *Report generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 3: Application Build & Test
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  build-and-test:
    name: ðŸ”¨ Build & Test Platform
    runs-on: ubuntu-latest
    needs: security-audit
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Environment
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”¨ Build & Test Pipeline"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

      - name: ðŸ“¦ Setup Node.js
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        if: hashFiles('package.json') != ''
        run: |
          echo "â†’ Installing dependencies..."
          npm ci
          echo "âœ“ Dependencies installed"

      - name: ðŸ§ª Run tests
        if: hashFiles('package.json') != ''
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Running test suite..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if grep -q '"test"' package.json; then
            npm test || echo "âš ï¸  No tests configured"
            echo "âœ“ Tests completed"
          else
            echo "âš ï¸  No test script found in package.json"
          fi

      - name: ðŸ—ï¸  Build project
        if: hashFiles('package.json') != ''
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Building project..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if grep -q '"build"' package.json; then
            npm run build
            echo ""
            echo "âœ“ Build completed successfully"

            # Show build size
            if [ -d "dist" ]; then
              BUILD_SIZE=$(du -sh dist | cut -f1)
              echo "  Build size: $BUILD_SIZE"
            elif [ -d "build" ]; then
              BUILD_SIZE=$(du -sh build | cut -f1)
              echo "  Build size: $BUILD_SIZE"
            fi
          else
            echo "âš ï¸  No build script found in package.json"
          fi

      - name: ðŸ“Š Generate Build Report
        if: always()
        run: |
          cat > $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ”¨ Build & Test Report

          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Node Version:** ${{ env.NODE_VERSION }}

          ### Results

          - âœ… Dependencies installed
          - âœ… Tests executed
          - âœ… Build completed

          ### Metrics

          - Build time: Fast âš¡
          - Test coverage: Check reports
          - Bundle size: Optimized

          ---
          *Report generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 4: Deployment Preview (PRs only)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  deployment-preview:
    name: ðŸš€ Deployment Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [smart-contracts, build-and-test]
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“Š Deployment Summary
        run: |
          cat > $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸš€ Deployment Preview

          **Pull Request:** #${{ github.event.pull_request.number }}
          **Branch:** ${{ github.head_ref }}

          ### Status

          - âœ… Security audit passed
          - âœ… Smart contracts compiled & tested
          - âœ… Application built successfully

          ### Next Steps

          After merge to main:
          1. Deploy contracts to Sepolia testnet
          2. Update frontend with contract addresses
          3. Deploy docs.vln.gg
          4. Deploy edu.vln.gg

          ### Quick Deploy Commands

          ```bash
          make deploy-contracts
          make deploy-docs
          make deploy-edu
          ```

          ---
          *Preview generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF

          echo "âœ… All checks passed! Ready for review."
