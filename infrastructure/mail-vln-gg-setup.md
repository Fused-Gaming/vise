# mail.vln.gg - Email Infrastructure Setup with Mailcow

**Purpose:** Professional email server for organizational communications, notifications, and user correspondence
**Technology:** Mailcow Dockerized (Complete mailserver solution)
**URL:** https://mail.vln.gg

## Overview

Mailcow is a complete, dockerized mail server solution that includes:
- Postfix (SMTP server)
- Dovecot (IMAP/POP3 server)
- SOGo (Webmail & Groupware)
- Rspamd (Spam filtering)
- ClamAV (Antivirus)
- Solr (Full-text search)
- Web admin UI

This setup provides enterprise-grade email hosting for the VISE platform.

## Why Mailcow?

**Advantages:**
- Complete solution in Docker containers
- Modern web interface for administration
- Excellent spam and virus protection
- Support for DKIM, SPF, DMARC
- Easy backup and recovery
- Active development and community
- Free and open-source

**Alternatives Considered:**
- **Mail-in-a-Box** - Simpler but less flexible
- **iRedMail** - Good but more complex setup
- **Managed Service (Gmail Workspace, ProtonMail)** - Easier but $6-10/user/month

## System Requirements

### Minimum Specifications

```yaml
CPU: 2 cores (4 recommended)
RAM: 4 GB (6 GB recommended)
Disk: 20 GB + storage for emails
OS: Ubuntu 22.04 LTS or Debian 11
Docker: Latest version
Docker Compose: Latest version
```

### Ports Required

```
25/tcp   - SMTP
143/tcp  - IMAP
465/tcp  - SMTPS (SMTP over SSL)
587/tcp  - Submission (SMTP with STARTTLS)
993/tcp  - IMAPS (IMAP over SSL)
4190/tcp - Sieve (mail filtering)
80/tcp   - HTTP (redirects to HTTPS)
443/tcp  - HTTPS (Admin UI & Webmail)
```

## DNS Configuration

### Required DNS Records

**Before installation, configure these DNS records:**

```dns
# MX Record (Mail Exchange)
@           MX    10    mail.vln.gg.

# A Record (IPv4)
mail        A           YOUR_SERVER_IPv4

# AAAA Record (IPv6, if available)
mail        AAAA        YOUR_SERVER_IPv6

# SPF Record (Sender Policy Framework)
@           TXT         "v=spf1 mx a:mail.vln.gg ~all"

# DMARC Record (Email Authentication)
_dmarc      TXT         "v=DMARC1; p=quarantine; rua=mailto:postmaster@vln.gg; ruf=mailto:postmaster@vln.gg; fo=1"

# Reverse DNS (PTR Record) - Configure with your hosting provider
YOUR_IP     PTR         mail.vln.gg.

# Autodiscover (for mail clients)
autodiscover    CNAME   mail.vln.gg.
autoconfig      CNAME   mail.vln.gg.
```

**DKIM Record:**
This will be generated by Mailcow after installation. You'll add it like:

```dns
dkim._domainkey     TXT     "v=DKIM1; k=rsa; p=YOUR_PUBLIC_KEY_GENERATED_BY_MAILCOW"
```

## Installation Steps

### 1. Prepare Server

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install required packages
sudo apt install -y \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg \
    lsb-release \
    git

# Install Docker
curl -fsSL https://get.docker.com | sh

# Install Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Add user to docker group
sudo usermod -aG docker $USER
newgrp docker

# Verify installations
docker --version
docker-compose --version
```

### 2. Configure Firewall

```bash
# Allow required ports
sudo ufw allow 25/tcp
sudo ufw allow 143/tcp
sudo ufw allow 465/tcp
sudo ufw allow 587/tcp
sudo ufw allow 993/tcp
sudo ufw allow 4190/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 22/tcp  # SSH

# Enable firewall
sudo ufw enable
sudo ufw status
```

### 3. Install Mailcow

```bash
# Change to preferred directory
cd /opt

# Clone Mailcow repository
sudo git clone https://github.com/mailcow/mailcow-dockerized
cd mailcow-dockerized

# Generate configuration
./generate_config.sh

# When prompted, enter:
# - Hostname: mail.vln.gg
# - Timezone: Your timezone (e.g., America/New_York)
```

### 4. Configure Mailcow

**Edit mailcow.conf:**

```bash
sudo nano mailcow.conf
```

**Important Settings:**

```conf
# Hostname (FQDN)
MAILCOW_HOSTNAME=mail.vln.gg

# Timezone
TZ=America/New_York

# Let's Encrypt (for SSL certificates)
SKIP_LETS_ENCRYPT=n
ADDITIONAL_SAN=

# Enable automatic SSL renewal
SKIP_CLAMD=n  # Keep ClamAV (antivirus)
SKIP_SOLR=n   # Keep Solr (search)

# Admin password (change this!)
# Will be asked during first startup

# Database password (auto-generated, do not change)
DBNAME=mailcow
DBUSER=mailcow
DBPASS=GENERATED_PASSWORD_HERE

# HTTP/HTTPS binding
HTTP_PORT=80
HTTPS_PORT=443
HTTP_BIND=0.0.0.0
HTTPS_BIND=0.0.0.0

# Enable IP version preference
IPV4_NETWORK=172.22.1
IPV6_NETWORK=fd4d:6169:6c63:6f77::/64

# Compose project name
COMPOSE_PROJECT_NAME=mailcow-dockerized

# Backup location
BACKUP_LOCATION=/var/backups/mailcow
```

### 5. Start Mailcow

```bash
# Pull Docker images
docker-compose pull

# Start Mailcow
docker-compose up -d

# Check status
docker-compose ps

# View logs
docker-compose logs -f

# Wait for Let's Encrypt to issue certificates (may take a few minutes)
```

### 6. Access Admin Panel

Navigate to: **https://mail.vln.gg**

**Default credentials:**
- Username: `admin`
- Password: `moohoo` (CHANGE IMMEDIATELY!)

### 7. Initial Configuration

**In the Mailcow admin UI:**

1. **Change admin password:**
   - Go to Settings > Admin
   - Set a strong password

2. **Add domain:**
   - Configuration > Mail Setup > Domains
   - Add domain: `vln.gg`

3. **Create mailboxes:**
   ```
   noreply@vln.gg      - Automated notifications
   support@vln.gg      - User support
   admin@vln.gg        - Administration
   security@vln.gg     - Security issues
   postmaster@vln.gg   - Required by RFC
   ```

4. **Configure DKIM:**
   - Configuration > Configuration & Details > DKIM
   - Generate DKIM key for vln.gg
   - Copy the DNS TXT record
   - Add it to your DNS provider

5. **Enable Two-Factor Authentication:**
   - User Settings > Two-Factor Authentication
   - Enable for admin account

## Email Accounts Setup

### Create Mailbox via CLI

```bash
# Enter Mailcow directory
cd /opt/mailcow-dockerized

# Create mailbox
docker-compose exec mysql-mailcow mysql -u mailcow -p$DBPASS mailcow -e "
INSERT INTO mailbox (username, password, name, maildir, quota, local_part, domain, active)
VALUES (
    'noreply@vln.gg',
    '{SSHA256}GENERATED_HASH',
    'VISE Notifications',
    'vln.gg/noreply/',
    10240,
    'noreply',
    'vln.gg',
    1
);"

# Or use the web UI (recommended)
```

### Via Web UI (Recommended)

1. Go to **Configuration > Mail Setup > Mailboxes**
2. Click **Add mailbox**
3. Fill in details:
   - Username: `noreply`
   - Domain: `vln.gg`
   - Full name: `VISE Notifications`
   - Quota: `10240` MB (10GB)
   - Password: Generate strong password
4. Click **Add**

## Integration with edu.vln.gg

### SMTP Configuration for Applications

**Environment variables for edu.vln.gg:**

```bash
# SMTP Settings
SMTP_HOST=mail.vln.gg
SMTP_PORT=587
SMTP_SECURE=true  # Use STARTTLS
SMTP_USER=noreply@vln.gg
SMTP_PASSWORD=your-secure-password
EMAIL_FROM=noreply@vln.gg
EMAIL_FROM_NAME=VISE Education
```

### Example: Send Email from Next.js

**lib/email/send-email.ts:**

```typescript
import nodemailer from 'nodemailer'

const transporter = nodemailer.createTransport({
  host: process.env.SMTP_HOST,
  port: parseInt(process.env.SMTP_PORT || '587'),
  secure: false, // Use STARTTLS
  auth: {
    user: process.env.SMTP_USER,
    pass: process.env.SMTP_PASSWORD
  }
})

export async function sendEmail({
  to,
  subject,
  html,
  text
}: {
  to: string
  subject: string
  html: string
  text?: string
}) {
  try {
    const info = await transporter.sendMail({
      from: `"${process.env.EMAIL_FROM_NAME}" <${process.env.EMAIL_FROM}>`,
      to,
      subject,
      text: text || '',
      html
    })

    console.log('Email sent:', info.messageId)
    return { success: true, messageId: info.messageId }
  } catch (error) {
    console.error('Error sending email:', error)
    throw error
  }
}

// Usage
await sendEmail({
  to: 'student@example.com',
  subject: 'Welcome to VISE',
  html: '<h1>Welcome!</h1><p>You have been enrolled in Module 1.</p>'
})
```

### Email Templates

**templates/welcome-email.html:**

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      background: #3eaf7c;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .content {
      padding: 20px;
      background: #f9f9f9;
    }
    .button {
      display: inline-block;
      padding: 12px 24px;
      background: #3eaf7c;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      margin: 20px 0;
    }
    .footer {
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Welcome to VISE!</h1>
    </div>
    <div class="content">
      <h2>Hello {{username}},</h2>
      <p>Your account has been successfully created. Get started with your Web3 education journey!</p>
      <a href="https://edu.vln.gg/dashboard" class="button">Go to Dashboard</a>
      <p>If you have any questions, reply to this email or visit our support center.</p>
    </div>
    <div class="footer">
      <p>VISE - Verified in Skills: Exploits</p>
      <p>You're receiving this because you signed up for VISE.</p>
    </div>
  </div>
</body>
</html>
```

## Backup & Recovery

### Automated Backups

**Create backup script:**

```bash
#!/bin/bash
# /opt/mailcow-dockerized/backup.sh

BACKUP_DIR="/var/backups/mailcow"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

# Create backup directory
mkdir -p $BACKUP_DIR

# Run Mailcow backup
cd /opt/mailcow-dockerized
./helper-scripts/backup_and_restore.sh backup all

# Move backup to backup directory
mv backup_* $BACKUP_DIR/backup_$DATE.tar.gz

# Compress and encrypt (optional)
# gpg --encrypt --recipient admin@vln.gg $BACKUP_DIR/backup_$DATE.tar.gz

# Upload to S3 (optional)
# aws s3 cp $BACKUP_DIR/backup_$DATE.tar.gz s3://vise-backups/mailcow/

# Delete old backups
find $BACKUP_DIR -name "backup_*.tar.gz" -mtime +$RETENTION_DAYS -delete

echo "Backup completed: backup_$DATE.tar.gz"
```

**Make executable and schedule:**

```bash
chmod +x /opt/mailcow-dockerized/backup.sh

# Add to crontab
crontab -e

# Run daily at 2 AM
0 2 * * * /opt/mailcow-dockerized/backup.sh >> /var/log/mailcow-backup.log 2>&1
```

### Restore from Backup

```bash
cd /opt/mailcow-dockerized

# Stop Mailcow
docker-compose down

# Restore from backup
./helper-scripts/backup_and_restore.sh restore /var/backups/mailcow/backup_YYYYMMDD_HHMMSS.tar.gz

# Start Mailcow
docker-compose up -d
```

## Security Hardening

### 1. Fail2Ban Integration

```bash
# Install Fail2Ban
sudo apt install fail2ban

# Create Mailcow jail
sudo nano /etc/fail2ban/jail.d/mailcow.conf
```

**mailcow.conf:**

```ini
[postfix]
enabled = true
port = smtp,465,submission
filter = postfix
logpath = /opt/mailcow-dockerized/data/logs/postfix/*
maxretry = 5
bantime = 3600

[dovecot]
enabled = true
port = pop3,pop3s,imap,imaps,submission,465
filter = dovecot
logpath = /opt/mailcow-dockerized/data/logs/dovecot/*
maxretry = 5
bantime = 3600

[sogo]
enabled = true
port = http,https
filter = sogo-auth
logpath = /opt/mailcow-dockerized/data/logs/sogo/*
maxretry = 5
bantime = 3600
```

```bash
# Restart Fail2Ban
sudo systemctl restart fail2ban
sudo fail2ban-client status
```

### 2. Rate Limiting

**In Mailcow Admin UI:**
- Configuration > Configuration & Details
- Set rate limits for:
  - Outbound mail per hour: 100
  - Recipients per mail: 50
  - Max size per mail: 25 MB

### 3. DNSBL (DNS Blacklist) Protection

**Enable in Rspamd:**
- Configuration > Configuration & Details > Rspamd
- Enable DNSBL checks
- Configure trusted networks

### 4. TLS/SSL Configuration

**Force TLS for SMTP:**

```bash
# Edit Postfix config
docker-compose exec postfix-mailcow postconf -e "smtpd_tls_security_level = may"
docker-compose exec postfix-mailcow postconf -e "smtp_tls_security_level = may"
docker-compose restart postfix-mailcow
```

## Monitoring & Maintenance

### Health Checks

**Check Mailcow status:**

```bash
cd /opt/mailcow-dockerized
docker-compose ps

# Check logs
docker-compose logs -f --tail=100

# Check specific service
docker-compose logs -f postfix-mailcow
docker-compose logs -f dovecot-mailcow
docker-compose logs -f rspamd-mailcow
```

### Mail Queue Management

**View mail queue:**

```bash
docker-compose exec postfix-mailcow mailq

# Flush queue
docker-compose exec postfix-mailcow postqueue -f

# Delete all queued mail
docker-compose exec postfix-mailcow postsuper -d ALL
```

### Database Maintenance

```bash
# Optimize database
docker-compose exec mysql-mailcow mysqlcheck -u mailcow -p$DBPASS --optimize mailcow

# Backup database only
docker-compose exec mysql-mailcow mysqldump -u mailcow -p$DBPASS mailcow > /var/backups/mailcow_db_$(date +%Y%m%d).sql
```

### Update Mailcow

```bash
cd /opt/mailcow-dockerized

# Backup before updating
./helper-scripts/backup_and_restore.sh backup all

# Update
./update.sh

# Check for issues
docker-compose ps
docker-compose logs
```

## Deliverability Best Practices

### 1. Warm Up IP Address

**Gradually increase sending volume:**

```
Day 1-2:    50 emails
Day 3-5:    100 emails
Day 6-10:   250 emails
Day 11-15:  500 emails
Day 16-20:  1000 emails
Day 21+:    Unlimited
```

### 2. Monitor Reputation

**Tools to check:**
- [MXToolbox](https://mxtoolbox.com/blacklists.aspx) - Check blacklists
- [Mail-Tester](https://www.mail-tester.com/) - Test email score
- [Google Postmaster Tools](https://postmaster.google.com/)
- [Microsoft SNDS](https://sendersupport.olc.protection.outlook.com/snds/)

### 3. Maintain List Hygiene

- Remove bounced addresses
- Implement double opt-in
- Honor unsubscribe requests immediately
- Clean inactive users periodically

### 4. Content Best Practices

- Avoid spam trigger words
- Maintain text/HTML balance
- Include physical address
- Provide easy unsubscribe
- Authenticate all emails (DKIM, SPF, DMARC)

## Troubleshooting

### Common Issues

**1. Emails going to spam:**

```bash
# Check DKIM signature
docker-compose exec rspamd-mailcow rspamadm dkim_keygen -s dkim -d vln.gg

# Verify SPF
dig TXT vln.gg +short | grep spf

# Check DMARC
dig TXT _dmarc.vln.gg +short
```

**2. Cannot send/receive emails:**

```bash
# Check if ports are open
sudo netstat -tlnp | grep -E '25|587|465|993'

# Check DNS
dig MX vln.gg +short
dig A mail.vln.gg +short

# Check logs
docker-compose logs postfix-mailcow | tail -50
```

**3. High memory usage:**

```bash
# Check container stats
docker stats

# Adjust ClamAV memory (if needed)
# Edit data/conf/clamav/freshclam.conf
# Add: MaxThreads 1
docker-compose restart clamd-mailcow
```

## Cost Estimate

```
VPS (2 vCPU, 4GB RAM):          $20/mo
Additional storage (100GB):     $10/mo
Backup storage (S3):            $5/mo
Domain (included):              $0

Total monthly cost:             ~$35/mo

Compare to managed email:
- Google Workspace:             $6/user/mo ($60/mo for 10 users)
- Microsoft 365:                $5/user/mo ($50/mo for 10 users)
- ProtonMail Business:          $8/user/mo ($80/mo for 10 users)

Savings with self-hosted:       ~$15-45/mo
```

## Success Metrics

- Email deliverability rate (>98%)
- Spam detection accuracy (>95%)
- Server uptime (>99.9%)
- Average delivery time (<5 seconds)
- Bounce rate (<2%)
- Blacklist status (0 listings)
- Queue size (near 0)

## Support Resources

- **Mailcow Docs**: https://docs.mailcow.email/
- **Community**: https://community.mailcow.email/
- **GitHub**: https://github.com/mailcow/mailcow-dockerized
- **Update Policy**: Monthly stable releases

---

**Related:** [docs.vln.gg Setup](./docs-vln-gg-setup.md) | [edu.vln.gg Setup](./edu-vln-gg-setup.md) | [Back to Architecture](./DEVOPS-ARCHITECTURE.md)
