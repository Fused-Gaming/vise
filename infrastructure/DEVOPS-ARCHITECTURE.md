# VISE DevOps Infrastructure Architecture

**Version:** 1.0.0
**Last Updated:** 2025-11-22
**Status:** Planning Phase

## Overview

This document outlines the complete DevOps infrastructure for the VISE platform, covering three primary domains:

- **docs.vln.gg**: Technical documentation and API references
- **edu.vln.gg**: Educational platform and course delivery
- **mail.vln.gg**: Email infrastructure for communications

## Architecture Principles

### Core Tenets

1. **Infrastructure as Code (IaC)**: All infrastructure defined in version-controlled code
2. **Immutable Infrastructure**: Replace rather than modify infrastructure
3. **Security First**: Zero-trust architecture with defense in depth
4. **Observability**: Comprehensive logging, metrics, and tracing
5. **Automation**: CI/CD for all deployments and operations
6. **Scalability**: Horizontal scaling for all services
7. **Cost Optimization**: Right-sizing resources and usage-based scaling

### Technology Stack

```
┌─────────────────────────────────────────────────────────────┐
│                     VISE Infrastructure                      │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ docs.vln.gg  │  │ edu.vln.gg   │  │ mail.vln.gg  │      │
│  │              │  │              │  │              │      │
│  │   VitePress  │  │   Next.js    │  │   Mailcow    │      │
│  │   Static     │  │   Full-Stack │  │   Docker     │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
│         │                 │                  │              │
│         └─────────────────┼──────────────────┘              │
│                           │                                 │
│                    ┌──────▼──────┐                          │
│                    │   Nginx      │                          │
│                    │   Reverse    │                          │
│                    │   Proxy      │                          │
│                    └──────┬───────┘                          │
│                           │                                 │
│                    ┌──────▼──────┐                          │
│                    │ Cloudflare  │                          │
│                    │ CDN + SSL   │                          │
│                    └─────────────┘                          │
│                                                               │
├─────────────────────────────────────────────────────────────┤
│                    Monitoring Layer                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  Prometheus │  │   Grafana   │  │   Loki      │         │
│  │   Metrics   │  │   Dashboards│  │   Logs      │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## Infrastructure Components

### 1. DNS & CDN Layer

**Provider:** Cloudflare

**Configuration:**
- DNS management for vln.gg and subdomains
- SSL/TLS termination with automatic certificate renewal
- DDoS protection and WAF (Web Application Firewall)
- Page rules for caching optimization
- Analytics and performance monitoring

**Records Required:**
```
docs.vln.gg     A/AAAA  → Origin Server IP
edu.vln.gg      A/AAAA  → Origin Server IP
mail.vln.gg     A/AAAA  → Mail Server IP
MX              MX      → mail.vln.gg (Priority 10)
SPF             TXT     → "v=spf1 mx ~all"
DKIM            TXT     → Generated by Mailcow
DMARC           TXT     → "v=DMARC1; p=quarantine; rua=mailto:..."
```

### 2. Compute Infrastructure

**Provider Options:**
1. **AWS EC2** (Recommended for production)
2. **DigitalOcean Droplets** (Cost-effective for MVP)
3. **Hetzner Cloud** (Best price/performance for EU)
4. **Railway/Vercel** (For static/frontend only)

**Instance Specifications:**

```yaml
Production Environment:
  docs_server:
    type: t3.small (AWS) / s-2vcpu-4gb (DO)
    cpu: 2 vCPU
    ram: 4 GB
    storage: 50 GB SSD

  edu_server:
    type: t3.medium (AWS) / s-4vcpu-8gb (DO)
    cpu: 4 vCPU
    ram: 8 GB
    storage: 100 GB SSD

  mail_server:
    type: t3.small (AWS) / s-2vcpu-4gb (DO)
    cpu: 2 vCPU
    ram: 4 GB
    storage: 100 GB SSD

  monitoring_server:
    type: t3.small (AWS) / s-2vcpu-4gb (DO)
    cpu: 2 vCPU
    ram: 4 GB
    storage: 50 GB SSD
```

### 3. Container Orchestration

**Technology:** Docker + Docker Compose

**Rationale:**
- Simpler than Kubernetes for initial deployment
- Adequate for 3-5 services
- Path to Kubernetes migration available
- Lower operational overhead

**Alternative:** Kubernetes (for scale beyond 10+ services)

### 4. Load Balancing & Reverse Proxy

**Technology:** Nginx

**Capabilities:**
- SSL/TLS termination (Let's Encrypt)
- HTTP/2 and HTTP/3 support
- Rate limiting
- Request routing by domain
- WebSocket support
- Static file caching

**Configuration:**
```nginx
# Example configuration structure
upstream docs_backend {
    server docs_app:3000;
}

upstream edu_backend {
    server edu_app:3000;
}

server {
    listen 443 ssl http2;
    server_name docs.vln.gg;

    ssl_certificate /etc/letsencrypt/live/docs.vln.gg/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/docs.vln.gg/privkey.pem;

    location / {
        proxy_pass http://docs_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 5. Database Infrastructure

**Primary Database:** PostgreSQL 15+

**Services:**
```yaml
edu_database:
  engine: PostgreSQL 15
  purpose: User data, course progress, achievements
  backup: Daily automated backups to S3
  replication: Standby replica for read scaling

mail_database:
  engine: MariaDB (built-in to Mailcow)
  purpose: Email accounts, aliases, logs
  backup: Daily automated backups

cache_layer:
  engine: Redis 7
  purpose: Session storage, API caching
  persistence: RDB + AOF
```

**Backup Strategy:**
- Automated daily backups to S3-compatible storage
- Point-in-time recovery capability
- 30-day retention for daily backups
- 90-day retention for weekly backups
- Annual backups retained indefinitely

### 6. Storage Solutions

**Static Assets:**
- Cloudflare R2 or AWS S3
- CDN distribution via Cloudflare
- Versioned deployments

**User Uploads:**
- IPFS for NFT metadata and images
- Pinata or NFT.Storage for pinning
- Fallback to S3 for non-blockchain assets

**Backups:**
- Automated to S3 or Backblaze B2
- Encrypted at rest
- Geographic redundancy

### 7. CI/CD Pipeline

**Platform:** GitHub Actions

**Pipeline Stages:**

```yaml
Development → Testing → Staging → Production

Triggers:
  - Push to main: Deploy to staging
  - Tag creation: Deploy to production (manual approval)
  - Pull request: Run tests only

Jobs:
  1. Lint & Code Quality
  2. Security Scanning (Snyk, Trivy)
  3. Unit Tests
  4. Integration Tests
  5. Build Docker Images
  6. Push to Registry
  7. Deploy to Environment
  8. Smoke Tests
  9. Notify Team
```

**Example Workflow:**
```yaml
name: Deploy to Production
on:
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build Docker Image
        run: docker build -t vise/edu:${{ github.ref_name }} .

      - name: Push to Registry
        run: docker push vise/edu:${{ github.ref_name }}

      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: deploy
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/vise
            docker-compose pull
            docker-compose up -d
            docker-compose exec -T app npm run migrate
```

### 8. Monitoring & Observability

**Stack:** Prometheus + Grafana + Loki

**Components:**

```yaml
Metrics (Prometheus):
  - System metrics (CPU, RAM, disk, network)
  - Application metrics (requests, errors, latency)
  - Database metrics (queries, connections, cache hit rate)
  - Blockchain metrics (gas prices, transaction status)

Logs (Loki):
  - Application logs
  - Access logs
  - Error logs
  - Audit logs

Dashboards (Grafana):
  - System health overview
  - Application performance
  - User analytics
  - Blockchain operations

Alerting:
  - Disk space > 80%
  - Memory usage > 90%
  - Error rate > 1%
  - Response time > 2s (p95)
  - SSL certificate expiry < 30 days
  - Deployment failures
```

**External Monitoring:**
- Uptime monitoring: UptimeRobot or Pingdom
- Synthetic monitoring: Check critical user flows
- Error tracking: Sentry

### 9. Security Infrastructure

**Security Layers:**

```
┌─────────────────────────────────────────┐
│          Security Perimeter              │
├─────────────────────────────────────────┤
│ 1. Cloudflare WAF & DDoS Protection     │
│ 2. Nginx Rate Limiting                  │
│ 3. Firewall (UFW/iptables)              │
│ 4. SSH Key-Only Access                  │
│ 5. VPN for Administrative Access        │
│ 6. Secrets Management (Vault/Doppler)   │
│ 7. Security Scanning (Trivy, Snyk)      │
│ 8. Audit Logging (All Admin Actions)    │
└─────────────────────────────────────────┘
```

**Firewall Rules:**
```bash
# Allow only necessary ports
22/tcp   - SSH (restricted to VPN/bastion)
80/tcp   - HTTP (redirect to HTTPS)
443/tcp  - HTTPS
25/tcp   - SMTP (mail server only)
587/tcp  - SMTP submission (mail server only)
993/tcp  - IMAPS (mail server only)
```

**Secrets Management:**
- Never commit secrets to Git
- Use environment variables
- Consider HashiCorp Vault or Doppler for centralized secrets
- Rotate credentials regularly (quarterly)
- Use service accounts with minimal permissions

### 10. Disaster Recovery

**Recovery Objectives:**
- **RTO (Recovery Time Objective):** 4 hours
- **RPO (Recovery Point Objective):** 1 hour

**Disaster Recovery Plan:**

```yaml
Backup Strategy:
  databases:
    frequency: Every 6 hours
    retention: 30 days
    storage: S3 with versioning

  application_state:
    frequency: Daily
    retention: 7 days

  configuration:
    frequency: On every change (Git)
    retention: Indefinite

Recovery Procedures:
  1. Provision new infrastructure (IaC)
  2. Restore databases from latest backup
  3. Deploy latest application version
  4. Update DNS if needed
  5. Verify functionality
  6. Monitor for issues

Testing:
  - Quarterly DR drills
  - Document results and improvements
  - Update runbooks
```

## Environment Strategy

### Development
- Local Docker Compose
- Mock blockchain (Hardhat Network)
- Seed data for testing
- Hot reload enabled

### Staging
- Mirrors production architecture
- Testnet blockchain integration
- Subset of production data
- Used for final testing before release

### Production
- Full redundancy
- Mainnet integration
- Production data
- Zero-downtime deployments

## Cost Estimation

### Monthly Infrastructure Costs (USD)

```
Compute:
  3x VPS (docs, edu, mail)       $60
  1x Monitoring VPS               $20

Storage:
  Database storage (100GB)        $10
  Object storage (500GB)          $10
  Backups (1TB)                   $20

Services:
  Cloudflare Pro                  $20
  Domain registration             $2
  IPFS Pinning (Pinata)          $20
  RPC Provider (Alchemy)          $0 (free tier)

Monitoring:
  UptimeRobot Premium             $8
  Sentry (Error tracking)         $26

Total Monthly Cost:              ~$196
Total Annual Cost:               ~$2,352

Scale-up costs (1000+ active users):
  Larger VPS instances           +$100/mo
  Additional compute             +$80/mo
  Increased storage              +$30/mo
  Enterprise services            +$100/mo
  -------------------------------
  Estimated at scale:            ~$500/mo
```

## Deployment Procedures

### Initial Setup Checklist

```markdown
- [ ] Register vln.gg domain
- [ ] Setup Cloudflare account and DNS
- [ ] Provision VPS instances
- [ ] Configure firewall rules
- [ ] Setup SSH key authentication
- [ ] Install Docker and Docker Compose
- [ ] Clone infrastructure repository
- [ ] Configure environment variables
- [ ] Generate SSL certificates
- [ ] Deploy Nginx reverse proxy
- [ ] Deploy PostgreSQL and Redis
- [ ] Deploy application services
- [ ] Configure monitoring stack
- [ ] Setup backup automation
- [ ] Configure CI/CD pipelines
- [ ] Perform smoke tests
- [ ] Document credentials in password manager
- [ ] Create operational runbooks
```

### Standard Deployment Process

1. **Pre-deployment:**
   - Run all tests locally
   - Create release notes
   - Notify team of deployment
   - Schedule during low-traffic period

2. **Deployment:**
   - Tag release in Git
   - Trigger CI/CD pipeline
   - Monitor deployment logs
   - Run automated smoke tests

3. **Post-deployment:**
   - Verify all services healthy
   - Check error rates in monitoring
   - Test critical user flows
   - Monitor for 30 minutes
   - Send completion notification

4. **Rollback Procedure:**
   - Keep previous Docker images
   - Document rollback command
   - Test rollback in staging first
   - Execute rollback if needed
   - Post-mortem required for all rollbacks

## Security Best Practices

### Application Security
- Input validation on all user inputs
- SQL injection prevention (parameterized queries)
- XSS prevention (content security policy)
- CSRF protection (tokens)
- Rate limiting on all APIs
- Authentication and authorization checks
- Secure session management

### Infrastructure Security
- Minimal attack surface (close unnecessary ports)
- Regular security updates (automated)
- Intrusion detection system
- Log aggregation and analysis
- Encrypted communications (TLS 1.3)
- Secrets rotation policy
- Security scanning in CI/CD

### Compliance
- GDPR compliance for EU users
- Data retention policies
- Right to deletion support
- Privacy policy documentation
- Terms of service
- Cookie consent management

## Operational Runbooks

### Common Operations

1. **Deploy new version**
2. **Scale up services**
3. **Restore from backup**
4. **Rotate SSL certificates**
5. **Update dependencies**
6. **Add new admin user**
7. **Investigate performance issues**
8. **Respond to security incident**

(Detailed runbooks to be created in separate documents)

## Migration Path

### Phase 1: MVP (Months 1-3)
- Single VPS for all services
- Manual deployments
- Basic monitoring
- Local backups

### Phase 2: Growth (Months 4-6)
- Separate VPS per service
- Automated CI/CD
- Comprehensive monitoring
- Remote backups with redundancy

### Phase 3: Scale (Months 7-12)
- Load-balanced services
- Database replication
- CDN for all assets
- Advanced security measures

### Phase 4: Enterprise (Year 2+)
- Multi-region deployment
- Kubernetes orchestration
- Advanced observability
- Dedicated security team

## Support & Maintenance

### Maintenance Windows
- **Standard:** Sundays 2-6 AM UTC
- **Emergency:** As needed with notification

### On-Call Rotation
- Primary on-call engineer
- Secondary backup
- Escalation to CTO if needed

### SLA Commitments
- Uptime: 99.5% (excluding maintenance)
- Response time: < 2 hours for critical issues
- Resolution time: < 24 hours for critical issues

## Documentation Requirements

### Must Maintain
1. Architecture diagrams (update quarterly)
2. Runbooks for all operations
3. Incident post-mortems
4. Change log for infrastructure
5. Access control matrix
6. Disaster recovery procedures
7. Security policies
8. Cost optimization reports

## Next Steps

1. Review and approve this architecture
2. Select cloud provider and create accounts
3. Create detailed implementation plan
4. Provision infrastructure using IaC (Terraform)
5. Implement CI/CD pipelines
6. Setup monitoring and alerting
7. Perform security audit
8. Load testing and optimization
9. Create operational runbooks
10. Train team on procedures

---

**Document Owner:** DevOps Team
**Review Cycle:** Quarterly
**Last Reviewed:** 2025-11-22
